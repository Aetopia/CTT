<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>blur -&gt; smoothie</title>
    <style>
        body {
            /* display: flex; */
            justify-content: center;
            align-items: center;
            height: 100%;
            margin-top: 1vh;
            /* margin: 0; */
            font-family: Arial, sans-serif;
        }

        #container {
            display: flex;
            width: auto;
        }

        #left,
        #right {
            margin-top: 1px;
            justify-content: center;
            padding: 10px;
            height: auto;
        }

        #left {
            justify-content: center;
            border-right: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <h1>
        <a target="_blank" rel="noopener noreferrer"
            href="https://github.com/f0e/blur?tab=readme-ov-file#config-settings-explained">blur config</a>
        -&gt;
        <a rel="noopener noreferrer" href="https://ctt.cx/recipe">smoothie recipe</a>
        converter
    </h1>

    <hr>
    Related resources:
    <ul>
        <li><a target="_blank" rel="noopener noreferrer" href="../smoothievsblur">blur config vs. sm recipe
                reference</a></li>
        <li><a target="_blank" rel="noopener noreferrer" href="../recipe">recipe reference</a></li>
        <li><a target="_blank" rel="noopener noreferrer" href="https://github.com/gem-storm/configtool">CLI
                alternative</a></li>
        <li><a target="_blank" rel="noopener noreferrer"
                href="https://github.com/couleur-tweak-tips/smoothie-rs/blob/main/target/recipe.ini">default smoothie
                recipe</a></li>
    </ul>
    <hr>

    <div id="container">
        <div id="left">
            <input type="checkbox" id="fullRecipe">
            <label for="fullRecipe">Return full* recipe</label>
            <br>

            <textarea placeholder="Paste your .blur-config.cfg here..." id="input" autocorrect="off" spellcheck="false"
                oninput="updateOutput()" autofocus rows="55" cols="40"></textarea>
        </div>
        <div id="right">

            <button type="button" id="copyout" onclick="Copy()">Copy and close tab</button>
            <br>
            <textarea id="output" autocorrect="off" spellcheck="false" rows="55" cols="40"></textarea>
        </div>
    </div>
    *In the sense of all of the equivalent filters available with blur

    <script>
        function parseBlur(inputText) {

            let lines = inputText.split("\n");

            let cur_category = "undefined";

            let config = {};

            lines.forEach(line => {

                if (line.startsWith("- ") && line.length >= 3) {

                    cur_category = line.slice(2).trim()

                    config[cur_category] = {};
                }
                else if (line.includes(":")) {
                    result = line.match(/^([^:]+):(.*)$/);
                    // console.log(`${line} -> ${result}`)
                    let key = result[1].trim();
                    let value = result[2].trim();

                    // console.log(config);
                    config[cur_category][key] = value;

                }

            });

            return config
        }
        function blurDefaultToRecipe(obj, key) {
            if (obj[key] == "default") {
                switch (key) {
                    case 'interpolation speed': { return 'medium' }
                    case 'interpolation tuning': { return 'weak' }
                    case 'interpolation algorithm': { return '13' }
                    case 'interpolation block size': { return '8' }
                    default: {
                        throw new Error(`Invalid default value query '${key}'`)
                    }
                }
            }
            else {
                return obj[key]
            }

        }
        function toSmoothie(config, returnFull) {

            let recipe = {};

            recipe["frame blending"] = {}
            recipe["frame blending"].enabled = config.blur.blur || "enabled"
            recipe["frame blending"].fps = config.blur["blur output fps"] || "60"
            recipe["frame blending"].intensity = config.blur["blur amount"] || "1.0"
            recipe["frame blending"].weighting = config.blur["blur weighting"] || "equal"

            recipe["interpolation"] = {}
            recipe["interpolation"].enabled = config.interpolation.interpolate || "true"
            recipe["interpolation"].fps = config.interpolation["interpolated fps"]
            recipe["interpolation"].speed = blurDefaultToRecipe(config["advanced interpolation"], "interpolation speed")
            recipe["interpolation"].tuning = blurDefaultToRecipe(config["advanced interpolation"], "interpolation tuning")
            recipe["interpolation"].algorithm = blurDefaultToRecipe(config["advanced interpolation"], "interpolation algorithm")
            recipe["interpolation"]["use gpu"] = config["advanced rendering"]["gpu"]

            if (!["0", null, undefined].includes(config["advanced interpolation"]["interpolation mask area"])) {
                recipe["interpolation"]["area"] = config["advanced interpolation"]["interpolation mask area"]
            }

            recipe["output"] = {}
            recipe["output"]["process"] = "ffmpeg"

            if (config["advanced rendering"]["custom ffmpeg filters"].trim() != "") {
                recipe["output"]["enc args"] = config["advanced rendering"]["custom ffmpeg filters"]
            } else {
                switch (config["advanced rendering"]["gpu type (nvidia/amd/intel)"]) {
                    case 'nvidia': {
                        recipe["output"]["enc args"] = "H264 NVENC"
                        break
                    }
                    case 'amd': {
                        recipe["output"]["enc args"] = "H264 AMF"
                        break
                    }
                    case 'intel': {
                        recipe["output"]["enc args"] = "H264 QUICKSYNC"
                        break
                    }
                    default: {
                        recipe["output"]["enc args"] = "H264 CPU"
                        break

                    }
                }
            }

            if (
                returnFull || [
                    config["timescale"]["input timescale"],
                    config["timescale"]["output timescale"],

                ].every(element => element != "1")
            ) {
                recipe["timescale"] = {}
                recipe["timescale"]["enabled"] = "true"
                recipe["timescale"]["in"] = config["timescale"]["input timescale"]
                recipe["timescale"]["out"] = config["timescale"]["output timescale"]

            }

            if (
                returnFull || [
                    config["filters"]["brightness"],
                    config["filters"]["saturation"],
                    config["filters"]["contrast"]
                ].every(element => element != "1")) {
                recipe["color grading"] = {}
                recipe["color grading"]["enabled"] = "true"
                recipe["color grading"]["brightness"] = config["filters"]["brightness"]
                recipe["color grading"]["saturation"] = config["filters"]["saturation"]
                recipe["color grading"]["contrast"] = config["filters"]["contrast"]

            }

            let ret = "";

            for (let category in recipe) {
                ret += "\n\n" + '[' + category + ']'
                for (let key in recipe[category]) {

                    ret += "\n" + key + ": " + recipe[category][key]
                }
            }

            return ret.substring(2)
        }

        function updateOutput() {

            let input = document.getElementById('input').value

            let output = ""
            if (input) {
                document.getElementById("copyout").disabled = false;
                output = toSmoothie(parseBlur(input), document.getElementById("fullRecipe").checked)
            } else {
                document.getElementById("copyout").disabled = true;
            }

            document.getElementById('output').value = output;
        }

        function Copy() {
            navigator.clipboard.writeText(
                document.getElementById('output').value
            );
            history.back();
            window.close();
        }

        document.getElementById("fullRecipe").addEventListener("change", function () {
            updateOutput();
        });

        updateOutput();
    </script>
</body>

</html>